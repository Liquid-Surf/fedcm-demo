<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/svg+xml" href="/solid.svg" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Simple Solid App</title>
  <script type="module" src="/solid.js"></script>
</head>

<body>
  <button id="startInruptLogin">Inrupt Login</button>
  <h1> 1. Solid-oidc FedCM Demo </h1>
  <p>CSS url:
    <input id="cssurl" />
  </p>
  <h2> 2. Login </h2>
  <p>Make sure your logged with your <a id="accountlink">css account</a></p>
  <button id="startFedcmLogin">fedcm login</button>
  <div id="loginstatus"></div>
  <p>access token:
    <input id="token" />
  </p>
  <h2> 3. Fetch a protected resource </h2>
  <div>
    <label for="resourceInput">Resource to view:</label>
    <input type="text" id="resourceInput" placeholder="e.g. http://localhost:3000/alice/private/secret" />
  </div>

  <!-- Button to fetch & display the file -->
  <button id="seeFileButton">See File</button>
  <div id="fileContent"></div>


  <script type="module">
    import { extractWebID, fetchRessource, getAccessToken,  InruptSession } from './solid.js'

    const session = new InruptSession()

    const handleSession = async (url = undefined) => {
      console.log("handling Incomming Redirect")
      const target = url ? url : window.location.href
      await session.handleIncomingRedirect(target);
      if (session.info.isLoggedIn) {
        console.log(`User is logged in with WebID: ${session.info.webId}`);
        console.log(session.info);
      } else {
        console.log('not logged in..')
      }
    }

    let DPOP_KEYS = null;
    let CSS_URL = 'http://localhost:3000/'

    document.getElementById('resourceInput').value = `${CSS_URL}a/profile/`
    document.getElementById('cssurl').value = `${CSS_URL}`
    document.getElementById('accountlink').href = `${CSS_URL}.account/`


    const callFedcm = async () => {
      const cssUrl = document.getElementById('cssurl').value
      const token = await startFedcmLogin(cssUrl)
      console.log(token)
      // window.location = token.token
      await handleSession(token.token)

      document.getElementById('token').value = authString.token
      // document.getElementById('loginstatus').innerText = `You are logged in with ${extractWebID(authString.token)}`
    }

    //const fetchTarget = async () => {
    //const target = document.getElementById('target').value
    //const token = document.getElementById('token').value
    //console.log('token', token)
    //const { accessToken, dpopKey } = await getAccessToken(token, CSS_URL)
    //console.log('access token', accessToken)
    //DPOP_KEYS = dpopKey
    //const resp = await fetchRessource(target, accessToken, DPOP_KEYS)
    //console.log("resp", resp)
    //document.getElementById('response').innerText = resp
    //}

    // Fetch resource

    const fetchFile = async () => {
      console.log('fetchFile', session)
      const fileContentDiv = document.getElementById("fileContent");
      fileContentDiv.textContent = "";
      const _fetch = session.info.isLoggedIn ?
        session.fetch
        : fetch

      // Resource URL from user input (falling back to placeholder if empty).
      const resourceUrl = resourceInput.value.trim() || resourceInput.placeholder;

      try {
        // Use the sessionâ€™s fetch, which includes credentials
        const response = await _fetch(resourceUrl);

        if (!response.ok) {
          fileContentDiv.textContent = `Cannot show file: ${response.status} ${response.statusText}`;
          return;
        }

        // Assuming the file is text-based, display the text
        const text = await response.text();
        fileContentDiv.textContent = text;
      } catch (err) {
        fileContentDiv.textContent = `Error fetching file: ${err}`;
      }
    }



    async function inruptLogin(cssUrl, session) {
      if (!session.info.isLoggedIn) {
        // Initiate login
        const login_response = await session.login({
          // clientId: `${window.location.href}clientid`,
          oidcIssuer: cssUrl,
          redirectUrl: window.location.href,
          clientName: "Solid Demo App",
          prompt: "consent",
          "handleRedirect": async (url) => {
            try {
              console.log("handle redirect ur ", url)
              const urlObj = new URL(url);
              const params = Object.fromEntries(urlObj.searchParams.entries());
              console.log("PARAMS", params)
              const token = await startFedcmLogin(params)
              console.log("TOKEN", token)
              window.location = token.token 
              // const res = await session.handleIncomingRedirect(token.token);
              // console.log("handling redirect res", res)
              // if (session.info.isLoggedIn) {
              //   console.log(`User is logged in with WebID: ${session.info.webId}`);
              //   console.log(session.info);
              // } else {
              //   console.log('not logged in..')
              // }
            } catch (err) {
              console.log("got an error during fedcm loggin..", err)
            }

          },
        });
        console.log("login_response", login_response)
      }

    }

    async function startFedcmLogin(params) {
      console.log('startFedcmLogin')
      // const params = parseUrlParam()
      console.log("params", params)
      // const clientId = `${window.location.protocol}//${window.location.host}/clientid`
      const identity_registered = {
        "providers": [
          {
            "configURL": `any`,
            "clientId": params.client_id,
            "registered": true,
            // "type": "webid",

            "params": {
              "code_challenge": params.code_challenge,
              "code_challenge_method": params.code_challenge_method,
              "state": params.state

            }

          }
        ]
      }
      console.log('requesting navigator\'s API..')
      try {
        const token = await navigator.credentials.get({
          identity: identity_registered
        })
        console.log('token', token)
        return token
      } catch (error) {
        console.log("Client Error calling the navigator api: ", error);
        return

      }
    }

    document.getElementById("seeFileButton")
      .addEventListener('click', async () => await fetchFile())
    document.getElementById('startFedcmLogin')
      .addEventListener('click', async () => await callFedcm());
    document.getElementById('startInruptLogin')
      .addEventListener('click', async () => await inruptLogin(CSS_URL, session));

    (async () => {
      await handleSession()
    })();


  </script>
</body>

</html>