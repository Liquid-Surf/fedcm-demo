<h1>Log in</h1>
<form method="post" id="mainForm">
  <p class="error" id="error"></p>

  <fieldset>
    <legend>Your account</legend>
    <ol>
      <li>
        <label for="email">Email</label>
        <input id="email" type="email" name="email" autofocus>
      </li>
      <li>
        <label for="password">Password</label>
        <input id="password" type="password" name="password">
      </li>
      <li class="checkbox">
        <label><input type="checkbox" name="remember" value="true" checked>Stay logged in</label>
      </li>
    </ol>
  </fieldset>

  <p class="actions">
    <button type="button" id="fedcm-registration" onClick="registerIdp" style="visibility:hidden;">Register IdP to FedCM </button>
    <button type="submit" name="submit" disabled>Log in</button>
    <button class="hidden" type="button" id="cancel">Cancel</button>
  </p>

  <ul class="actions">
    <li><a id="register-link" href="" class="link">Sign up</a></li>
    <li><a id="forgot-link"  href="" class="link">Forgot password</a></li>
  </ul>
</form>


<script>

    const registerIdp = async () => {
    	console.log("Idp registration")
      const fedcm_config_url = window.location.protocol + '//' + window.location.host + '/.well-known/fedcm/fedcm.json'
      try {
        const success = IdentityProvider.register(fedcm_config_url)
        if ( success ) console.log('registration successfull');
      } catch (err) {
      	console.log("error during IdP registration: ", err)
      }
    }

  (async() => {

    let isFedcmWithIdpRegistrationEnabled = false
    try {
      if (IdentityProvider && IdentityProvider.register) // if the browser allows FedCM idp registration
        isFedcmWithIdpRegistrationEnabled = true;
    }catch(error){
      console.log("If you are trying to use FedCM, be sure to run chrome canary > 145 with the correct flags enabled, see https://github.com/Liquid-Surf/fedcm-demo/")
    }
    
    if (isFedcmWithIdpRegistrationEnabled) 
      document.getElementById("fedcm-registration").style.visibility = "visible"

    document.getElementById('fedcm-registration')
      .addEventListener('click', async () => await registerIdp())

    let controls = await fetchControls('<%= idpIndex %>');



    // Only show the cancel button if there is an OIDC interaction
    setVisibility('cancel', <%= authenticating %>);
    getElements('cancel').cancel.addEventListener('click', async() => {
      const res = await fetch(controls.oidc.cancel, { method: 'POST' });
      location.href = (await res.json()).location;
    });

    addPostListener(async() => {
      const json = await postJsonForm(controls.password.login, false,
        (json) => Object.assign(json, { remember: Boolean(json.remember) }));
      // In case there was no forced OIDC redirect, just go to the main account page
      if (json) { // ( <- this mean loggin is successful )
        // Now with cookie
        controls = await fetchControls('<%= idpIndex %>');

        if(isFedcmWithIdpRegistrationEnabled){
          // TODO: is there a better way to get account Id ?
          const id = controls.html.account.account.replace(controls.account.create ,'').slice(0,-1) // slice to remove trailling slash
          const name = await getAccountName(controls)
          const email = await getAccountEmail(controls)
          console.log('lets try to push the account now');
          console.log(controls)
          // TODO get picture from webid ?
          try {
            await navigator.login.setStatus("logged-in", {
              accounts: [{
                  id,
                  name,
                  email,
                  picture: "", 
              }]
            })
            console.log("Pushed account successfully")
          } catch (error) {
            console.log("Could not set login status to 'logged-in': ", error)
          }
        }

        location.href = controls.html.account.account;
      }
    });

    const getAccountEmail = async (controls) => {
      const { passwordLogins } = await fetchJson(controls.password.create)
      return Object.entries(passwordLogins)[0][0] // TODO: unsafely assuming one email per account
    }

    const getAccountName = async (controls) => {
      // let's assume the name is the Pod name
      // TODO: fetch name from webId if possible
      const { pods } = await fetchJson(controls.account.pod)
      return Object.entries(pods)[0][0] // TODO: unsafely assuming one Pod per account
        .replace(document.location.origin, '')
        .replaceAll('/','')

    }

    updateElement('register-link', controls.html.password.register, { href: true });
    updateElement('forgot-link', controls.html.password.forgot, { href: true });
  })();
</script>

